From 65590c6dd88a1b634db16aee60e3d64a1ba34961 Mon Sep 17 00:00:00 2001
From: Samuel Dionne-Riel <samuel@dionne-riel.com>
Date: Sat, 14 Dec 2024 00:37:58 -0500
Subject: [PATCH 1/3] makepkg: Don't write date and version for reproducible
 source tarballs

Signed-off-by: Samuel Dionne-Riel <samuel@dionne-riel.com>
---
 scripts/libmakepkg/srcinfo.sh.in | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/scripts/libmakepkg/srcinfo.sh.in b/scripts/libmakepkg/srcinfo.sh.in
index c43d4cee..1f22a798 100644
--- a/usr/share/makepkg/srcinfo.sh
+++ b/usr/share/makepkg/srcinfo.sh
@@ -112,8 +112,12 @@ srcinfo_write_package() {
 }
 
 write_srcinfo_header() {
-	printf "# Generated by makepkg %s\n" "$makepkg_version"
-	printf "# %s\n" "$(LC_ALL=C date -u)"
+	if (( REPRODUCIBLE )); then
+		printf "# Generated by makepkg in reproducible mode."
+	else
+		printf "# Generated by makepkg %s\n" "$makepkg_version"
+		printf "# %s\n" "$(LC_ALL=C date -u)"
+	fi
 }
 
 write_srcinfo_content() {
-- 
2.47.0


From 4691f8c7682505e35dda608e9bbdd35f7b25cdc4 Mon Sep 17 00:00:00 2001
From: Samuel Dionne-Riel <samuel@dionne-riel.com>
Date: Sat, 14 Dec 2024 00:37:33 -0500
Subject: [PATCH 2/3] makepkg: unify source time for reproducible source
 tarballs

Signed-off-by: Samuel Dionne-Riel <samuel@dionne-riel.com>
---
 scripts/makepkg.sh.in | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/scripts/makepkg.sh.in b/scripts/makepkg.sh.in
index 75df3650..862d1e42 100644
--- a/usr/bin/makepkg
+++ b/usr/bin/makepkg
@@ -687,6 +687,9 @@ create_srcpackage() {
 		if [[ "$file" = "$(get_filename "$file")" ]] || (( SOURCEONLY == 2 )); then
 			local absfile
 			absfile=$(get_filepath "$file") || missing_source_file "$file"
+			if (( REPRODUCIBLE )); then
+				touch -d @$SOURCE_DATE_EPOCH "$absfile"
+			fi
 			msg2 "$(gettext "Adding %s...")" "${absfile##*/}"
 			ln -s "$absfile" "$srclinks/$pkgbase"
 		fi
@@ -728,6 +731,12 @@ create_srcpackage() {
 	local fullver=$(get_full_version)
 	local pkg_file="$SRCPKGDEST/${pkgbase}-${fullver}${SRCEXT}"
 
+	if (( REPRODUCIBLE )); then
+		# We have activated reproducible builds, so unify source times before
+		# building
+		find "${srclinks}/${pkgbase}" -exec touch -h -d @$SOURCE_DATE_EPOCH {} +
+	fi
+
 	# tar it up
 	msg2 "$(gettext "Compressing source package...")"
 	cd_safe "${srclinks}"
-- 
2.47.0


From d2ff71aa8166a7457a5cc83b713ed472cc90c76d Mon Sep 17 00:00:00 2001
From: Samuel Dionne-Riel <samuel@dionne-riel.com>
Date: Sat, 14 Dec 2024 02:19:57 -0500
Subject: [PATCH 3/3] makepkg: Use sorted inputs for source tarballs too

Signed-off-by: Samuel Dionne-Riel <samuel@dionne-riel.com>
---
 scripts/makepkg.sh.in | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/scripts/makepkg.sh.in b/scripts/makepkg.sh.in
index 862d1e42..7d55647d 100644
--- a/usr/bin/makepkg
+++ b/usr/bin/makepkg
@@ -743,7 +743,8 @@ create_srcpackage() {
 
 	# TODO: Maybe this can be set globally for robustness
 	shopt -s -o pipefail
-	LANG=C bsdtar --no-fflags --no-read-sparse -cLf - ${pkgbase} | compress_as "$SRCEXT" > "${pkg_file}" || ret=$?
+	list_package_files | LANG=C bsdtar --no-fflags --no-read-sparse -cnLf - --null --files-from - |
+		compress_as "$SRCEXT" > "${pkg_file}" || ret=$?
 
 	shopt -u -o pipefail
 
-- 
2.47.0

